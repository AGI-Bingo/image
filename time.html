<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dynamic Router</title>
</head>
<body>
<script>
  // Route handlers dictionary
  const routes = {
    "time.png": generateTimeImage,
    "time": generateTimeImage,
    // Add more routes here, e.g., "example.png": generateExampleImage
  };

  // Router logic
  const path = decodeURIComponent(location.pathname.slice(2)); // Extract path
  const routeHandler = routes[path];

  if (routeHandler) {
    // If the route exists, call the handler
    routeHandler();
  } else {
    // Fallback for unknown routes
    document.body.innerHTML = "<h1>404 - Not Found</h1>";
  }
generateTimeImage()
  
 
  async function generateTimeImage() {
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = 800;
    canvas.height = 600; // Increased height for more text lines

    // Background
    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    // Fetch IP address
    const ip = await fetchIP();

    // Get the referrer (origin URL)
    const referrer = document.referrer || "Direct Access";

    // Text
    const now = new Date();
    ctx.fillStyle = "purple";
    ctx.font = "30px Arial";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";

    // Write current time
    ctx.fillText(now.toLocaleString(), canvas.width / 2, canvas.height / 5);

    // Write IP address
    ctx.fillText(`IP: ${ip}`, canvas.width / 2, (canvas.height / 5) * 2);

    // Write referrer URL
    ctx.fillText(`Referrer: ${referrer}`, canvas.width / 2, (canvas.height / 5) * 3);

    // Convert canvas to Blob and return as image
    canvas.toBlob((blob) => {
      const blobURL = URL.createObjectURL(blob);
      // Redirect the browser to the Blob URL to serve the image
      if (isEmbeddedRequest()) {
        serveImageBlob(blob);
      } else {
        location.href = blobURL;
      }
    }, "image/png");
  }

  // Detect if the request is from an embedded context
  function isEmbeddedRequest() {
    return location.pathname.endsWith(".png");
  }

  // Serve the image Blob directly in the response
  function serveImageBlob(blob) {
    const headers = new Headers();
    headers.set("Content-Type", "image/png");
    const fileReader = new FileReader();
    fileReader.onloadend = () => {
      const imgData = fileReader.result.split(",")[1]; // Base64 encoded data
      document.write(`<img src="data:image/png;base64,${imgData}" alt="Generated Image"/>`);
    };
    fileReader.readAsDataURL(blob);
  }

  // Fetch IP address using a public API
  async function fetchIP() {
    try {
      const response = await fetch("https://api.ipify.org?format=json");
      const data = await response.json();
      return data.ip;
    } catch (error) {
      console.error("Error fetching IP address:", error);
      return "Unknown IP";
    }
  }
</script>
</body>
</html>
